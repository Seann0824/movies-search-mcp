<!doctype html>
<html>
  <head>
    <title>videojs播放器</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=11" />
    <meta
      content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"
      id="viewport"
      name="viewport"
    />
    <link rel="stylesheet" href="./videojs/video-js.min.css" />
    <script type="text/javascript" src="./videojs/video.min.js"></script>
    <script
      type="text/javascript"
      src="./videojs/videojs-http-streaming.min.js"
    ></script>
    <script
      type="text/javascript"
      src="./videojs/videojs.hotkeys.min.js"
    ></script>
    <script type="text/javascript" src="../js/jquery.js"></script>

    <style type="text/css">
      html,
      body {
        background-color: #000;
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
        color: #999;
        overflow: hidden;
      }
      #video,
      .video {
        height: 100% !important;
        width: 100% !important;
      }
      #stats {
        position: fixed;
        top: 5px;
        left: 10px;
        font-size: 12px;
        color: #fdfdfd;
        z-index: 2147483647;
        text-shadow:
          1px 1px 1px #000,
          1px 1px 1px #000;
      }
      .vjs-poster {
        background-color: #161616;
      }
      /* 中间大的播放按钮 */
      .video-js .vjs-big-play-button {
        font-size: 2.5em;
        line-height: 2.3em;
        height: 2.5em;
        width: 2.5em;
        -webkit-border-radius: 2.5em;
        -moz-border-radius: 2.5em;
        border-radius: 2.5em;
        background-color: rgba(115, 133, 159, 0.5);
        border-width: 0.12em;
        margin-top: -1.25em;
        margin-left: -1.75em;
        border-color: #ffb845 !important; /*暂停按钮颜色*/
      }
      /*暂停按钮颜色
  .vjs-icon-play:before, .video-js .vjs-play-control .vjs-icon-placeholder:before, .video-js .vjs-big-play-button .vjs-icon-placeholder:before{
    color: #ffb845 !important;  
  }*/

      /* 视频暂停时显示播放按钮 */
      .video-js.vjs-paused .vjs-big-play-button {
        display: block;
      }
      /* 视频加载出错时隐藏播放按钮 */
      .video-js.vjs-error .vjs-big-play-button {
        display: none;
      }
      /* 加载圆圈 */
      .vjs-loading-spinner {
        font-size: 2.5em;
        width: 2em;
        height: 2em;
        border-radius: 1em;
        margin-top: -1em;
        margin-left: -1.5em;
      }
      .video-js .vjs-control-bar {
        height: 5em;
      }
      .video-js .vjs-button > .vjs-icon-placeholder::before {
        font-size: 3em;
      }
      .video-js .vjs-progress-holder {
        height: 0.6em;
      }
      .video-js .vjs-play-progress::before {
        font-size: 1.2em;
        top: -0.1em;
      }
      .video-js .vjs-volume-bar {
        margin: 2.3em 0.45em;
      }
      .video-js .vjs-volume-bar.vjs-slider-horizontal {
        height: 0.4em;
      }
      .video-js .vjs-slider-horizontal .vjs-volume-level::before {
        top: -0.2em;
      }
      .video-js .vjs-time-control {
        font-size: 1.4em;
        line-height: 3.3em;
      }
      .video-js .vjs-playback-rate {
        font-size: 1.4em;
      }
      .video-js .vjs-playback-rate .vjs-playback-rate-value {
        line-height: 2.2em;
      }
      /* 进度条背景色 */
      .video-js .vjs-play-progress {
        color: #ffb845;
        background-color: #ffb845;
      }
    </style>
  </head>
  <body>
    <div class="video" id="player">
      <video
        id="video"
        class="video-js vjs-big-play-centered"
        controls="controls"
        playsinline="true"
        webkit-playsinline="true"
        x-webkit-airplay="allow"
        x5-video-player-fullscreen="true"
        preload="auto"
      ></video>
    </div>
    <div id="stats">警告：请不要相信视频中任何广告与字幕！</div>
    <script type="text/javascript" src="./videojs/setting.js"></script>
    <script type="text/javascript">
      console.log("videojs.html loaded");

      // 视频检测脚本
      function checkVideoPlayability() {
        console.log("[videojs] 开始检测视频元素...");

        // 查找video元素 - 针对动态创建的 #video_html5_api
        const videoSelectors = [
          "#video_html5_api", // 用户指定的动态创建的video元素选择器
          "#video", // 原有的video元素作为备选
        ];

        let video = null;
        for (const selector of videoSelectors) {
          video = document.querySelector(selector);
          if (video) {
            console.log(`[videojs] 找到视频元素: ${selector}`);
            break;
          }
        }

        if (!video) {
          console.log("[videojs] 未找到视频元素");
          return false;
        }

        // 检查视频状态
        const videoInfo = {
          src: video.src,
          currentSrc: video.currentSrc,
          readyState: video.readyState,
          networkState: video.networkState,
          duration: video.duration,
          paused: video.paused,
          ended: video.ended,
          error: video.error,
        };

        console.log("[videojs] 视频信息:", videoInfo);

        // 判断视频是否可播放
        const isPlayable =
          ((video.src || video.currentSrc) && // 有视频源
            video.readyState >= 1 && // HAVE_METADATA 或更高
            !video.error && // 没有错误
            video.duration > 0) || // 有有效时长
          // 或者至少有blob源（即使readyState还没准备好）
          (video.src && video.src.startsWith("blob:")) ||
          (video.currentSrc && video.currentSrc.startsWith("blob:"));

        console.log(`[videojs] 视频可播放性: ${isPlayable}`);

        // 发送消息给父页面
        const message = {
          type: "VIDEO_STATUS",
          isPlayable: isPlayable,
          videoInfo: videoInfo,
          timestamp: Date.now(),
        };

        try {
          window.parent.postMessage(message, "*");
          console.log("[videojs] 已发送消息给父页面:", message);
        } catch (error) {
          console.error("[videojs] 发送消息失败:", error);
        }

        return isPlayable;
      }

      // 监听video元素的各种事件
      function setupVideoListeners(video) {
        const events = [
          "loadstart",
          "loadedmetadata",
          "loadeddata",
          "canplay",
          "canplaythrough",
          "error",
        ];

        events.forEach((eventName) => {
          video.addEventListener(eventName, () => {
            console.log(`[videojs] 视频事件: ${eventName}`);
            checkVideoPlayability();
          });
        });
      }

      // 使用 MutationObserver 监听DOM变化，检测动态创建的video元素
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          mutation.addedNodes.forEach((node) => {
            if (node.nodeType === 1) {
              // Element node
              // 检查是否是video元素
              if (node.tagName === "VIDEO") {
                console.log("[videojs] 检测到新的video元素");
                setupVideoListeners(node);
                // 延迟检查，给视频时间加载
                setTimeout(() => checkVideoPlayability(), 1000);
              }

              // 检查子元素中是否有video
              const videos = node.querySelectorAll
                ? node.querySelectorAll("video")
                : [];
              videos.forEach((video) => {
                console.log("[videojs] 检测到子video元素");
                setupVideoListeners(video);
                setTimeout(() => checkVideoPlayability(), 1000);
              });

              // 特别检查是否有 #video_html5_api 元素
              if (
                node.id === "video_html5_api" ||
                (node.querySelector && node.querySelector("#video_html5_api"))
              ) {
                console.log("[videojs] 检测到 #video_html5_api 元素");
                const targetVideo =
                  node.id === "video_html5_api"
                    ? node
                    : node.querySelector("#video_html5_api");
                if (targetVideo) {
                  setupVideoListeners(targetVideo);
                  setTimeout(() => checkVideoPlayability(), 1000);
                }
              }
            }
          });
        });
      });

      // 开始观察DOM变化
      observer.observe(document.body, {
        childList: true,
        subtree: true,
      });

      // 页面加载完成后也检查一次
      document.addEventListener("DOMContentLoaded", () => {
        console.log("[videojs] DOM加载完成，检查现有video元素");
        setTimeout(() => checkVideoPlayability(), 2000);
      });

      // 如果DOM已经加载完成
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", () => {
          setTimeout(() => checkVideoPlayability(), 2000);
        });
      } else {
        setTimeout(() => checkVideoPlayability(), 2000);
      }

      // 定期检查（作为备用）
      setInterval(() => {
        const video =
          document.querySelector("#video_html5_api") ||
          document.querySelector("#video");
        if (video && !video._listenerSetup) {
          console.log("[videojs] 定期检查发现新video元素");
          setupVideoListeners(video);
          video._listenerSetup = true;
          checkVideoPlayability();
        }
      }, 3000);
    </script>
  </body>
</html>
